Если письмо, пришедшее на один из адресов ПланФикса, соответствует условиям срабатывания сразу в нескольких правилах обработки писем, будет применен следующий алгоритм обработки: 


  * создаются и заполняются данными [ инфоблоки](Коммуникации/Правило_для_почты__Извлечение_данных.md) из всех таких правил;

  * создается объект, указанный в [ основной операции](Коммуникации/Правило_для_почты__Основная_операция.md) последнего правила;

  * если основная операция правила - это Создание задачи по шаблону и эта же операция является основной в остальных правилах - изменения задачи из них добавляются к этой основной операции

  * над объектом проводятся [ дополнительные операции](Коммуникации/Правило_для_почты__Дополнительные_операции.md) из всех правил (если они могут быть проведены над этим объектом).


  


## Для чего используется наложение


Изначально наложение правил использовалось достаточно широко, т.к. сами правила имели очень простую структуру. Современный вид правил существенно отличается от первоначального, поэтому в большинстве случаев использование наложения правил необосновано и не рекомендуется, т.к. поддерживать набор правил, которые должны накладываться на письмо, существенно сложнее, чем отдельные комплексные правила. 


Пример ситуации, когда использование наложения правил может быть оправданно: 


  * Представим, что в ПланФикс направляются письма, каждое из которых может содержать различающиеся между собой наборы параметров. Например, это пересылаемые вручную в систему письма, к теме которых при пересылке добавляются метки для распределения задач по исполнителям, проектам и т.п.

  * Пример темы пересылаемого письма: **Fw: Запрос на подписку #Иванов $Запросы клиентов** , где **#Иванов** это инструкция добавить к задаче исполнителем сотрудника по фамилии Иванов, а **$Запросы клиентов** это инструкция поместить задачу в проект "Запросы клиентов".

  * Для реализации такой обработки в список правил для адреса, на которые направляются такие письма, добавляются два отдельных правила, каждое из которых реализует одну инструкцию: первое правило подбирает исполнителя по метке #, а второе - проект по метке $.

  * Условия срабатывания этих правил сознательно выстраиваются таким образом чтобы приходящие на этот адрес письма попадали под каждое из них.

  * При обработке письма, оно последовательно прогоняется через все правила и система накапливает набор параметров, которые должны быть применены к созданной по письму задаче.

  * Такой подход позволяет добавлять отдельные, относительно простые правила-инструкции, видеть их в списке и при необходимости редактировать их или добавлять новые.


Алгоритм наложения правил работает в расчете именно на такие случаи. Попытка использовать наложение правил для других ситуауций, в том числе накладывать на одно письмо одновременно правила создания задач и добавления комментариев или создания контактов, не считается корректным использованием системы и соответствие результатов такого наложения ожиданиям настроившего правила пользователя не гарантируется. 


  


## Параметры, влияющие на наложение правил


  * В нижней части окна создания правила обработки почты есть чекбокс **Использовать только это правило без наложения других** :


![E9QkQG.jpg](images/E9QkQG.jpg)


  

Если этот чекбокс активен (стоит галочка), то наложение правил не используется и к письму будет применено только это правило. Если письмо соответствует условиям нескольких правил с активированным чекбоксом, отработает первое из них. 


  * В [ основном действии](Коммуникации/Правило_для_почты__Основная_операция.md) правила при выборе варианта "Создать задачу по шаблону" присутствует опция **Не использовать этот шаблон при наложении правил** :


![cktgxb.jpg](images/cktgxb.jpg)


Если этот чекбокс активирован, при наложении правил для создании задачи будет использован шаблон из другого правила.
